<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>GymPro Absolute - Ultimate Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --p: #d1fa1e;
        --bg: #000;
        --card: #121212;
        --border: #252525;
        --danger: #ff4d4d;
        --gray: #666;
      }
      body {
        font-family: "Inter", system-ui, sans-serif;
        background: var(--bg);
        color: #fff;
        margin: 0;
        padding: 15px;
        padding-bottom: 120px;
        overflow-x: hidden;
      }

      /* Stats & Header */
      .header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        gap: 8px;
      }
      .stat-card {
        background: var(--card);
        padding: 12px;
        border-radius: 16px;
        flex: 1;
        border: 1px solid var(--border);
        text-align: center;
      }
      .stat-card b {
        color: var(--p);
        font-size: 1.1rem;
        display: block;
      }

      .timer-hero {
        background: var(--p);
        color: #000;
        padding: 20px;
        border-radius: 24px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(209, 250, 30, 0.2);
        cursor: pointer;
      }
      #clock {
        font-size: 3.5rem;
        font-weight: 900;
        margin: 0;
        line-height: 1;
      }

      .filter-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        overflow-x: auto;
      }
      .filter-btn {
        flex: 1;
        min-width: 90px;
        padding: 12px;
        background: var(--card);
        border: 1px solid var(--border);
        color: #fff;
        border-radius: 12px;
        font-weight: 800;
        cursor: pointer;
        border: none;
      }
      .filter-btn.active {
        background: var(--p);
        color: #000;
        border-color: var(--p);
      }

      /* Cards */
      .exercise-card {
        background: var(--card);
        border-radius: 24px;
        padding: 18px;
        border: 1px solid var(--border);
        margin-bottom: 15px;
        position: relative;
      }
      .muscle-tag {
        font-size: 0.6rem;
        color: var(--p);
        text-transform: uppercase;
        font-weight: 900;
        background: rgba(209, 250, 30, 0.1);
        padding: 4px 10px;
        border-radius: 20px;
      }
      .last-log {
        font-size: 0.7rem;
        color: var(--gray);
        margin-top: 5px;
        font-weight: 600;
      }

      .grid-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin: 15px 0;
      }
      .input-box {
        background: #000;
        padding: 10px;
        border-radius: 14px;
        border: 1px solid #222;
        position: relative;
      }
      .input-box label {
        font-size: 0.55rem;
        color: #555;
        display: block;
        margin-bottom: 4px;
        font-weight: 700;
      }
      input {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.1rem;
        font-weight: bold;
        width: 100%;
        text-align: center;
        outline: none;
      }

      .inc-btn {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 30%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--p);
        font-size: 1.2rem;
        cursor: pointer;
        opacity: 0.4;
      }
      .inc-minus {
        left: 0;
      }
      .inc-plus {
        right: 0;
      }

      .sets-dots {
        display: flex;
        justify-content: space-between;
        gap: 8px;
      }
      .dot {
        flex: 1;
        height: 45px;
        background: #222;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
        border: 1px solid transparent;
      }
      .dot.active {
        background: var(--p);
        color: #000;
        border-color: var(--p);
      }

      /* Painéis */
      .panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 1000;
        display: none;
        padding: 25px;
        box-sizing: border-box;
        overflow-y: auto;
      }
      .btn-action {
        background: var(--p);
        border: none;
        padding: 20px;
        border-radius: 18px;
        width: 100%;
        font-weight: 900;
        margin-top: 10px;
        cursor: pointer;
        text-transform: uppercase;
      }

      /* Área de Sugestões */
      .feedback-item {
        background: #111;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #222;
        margin-bottom: 8px;
        font-size: 0.8rem;
        color: #eee;
        position: relative;
      }
      .del-feed {
        color: var(--danger);
        position: absolute;
        right: 12px;
        top: 12px;
        font-weight: bold;
      }

      .nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(8, 8, 8, 0.9);
        backdrop-filter: blur(15px);
        display: flex;
        padding: 15px 0;
        border-top: 1px solid #222;
        z-index: 100;
      }
      .nav-btn {
        flex: 1;
        text-align: center;
        font-size: 0.65rem;
        color: #555;
        font-weight: bold;
        cursor: pointer;
        text-transform: uppercase;
      }
      .nav-btn.active {
        color: var(--p);
      }
    </style>
  </head>
  <body>
    <div id="main-content">
      <div class="header">
        <div class="stat-card">
          <small>SESSÃO</small><b id="session-clock">00:00</b>
        </div>
        <div class="stat-card">
          <small>CARGA TOTAL</small><b id="total-vol">0</b>
        </div>
      </div>

      <div class="filter-bar">
        <button class="filter-btn active" onclick="setFilter('A', this)">
          TREINO A
        </button>
        <button class="filter-btn" onclick="setFilter('B', this)">
          TREINO B
        </button>
        <button class="filter-btn" onclick="setFilter('C', this)">
          TREINO C
        </button>
      </div>

      <div class="timer-hero" onclick="resetTimer()">
        <h1 id="clock">00:00</h1>
        <small style="font-weight: bold; letter-spacing: 1px">DESCANSAR</small>
      </div>

      <div id="workout-list"></div>
      <button class="btn-action" onclick="finishSession()">
        FINALIZAR TREINO
      </button>
    </div>

    <div id="edit-panel" class="panel">
      <h2 style="color: var(--p)">CONFIGURAR</h2>
      <input type="hidden" id="edit-id" />
      <input
        type="text"
        id="edit-name"
        placeholder="Nome do Exercício"
        style="
          width: 100%;
          padding: 15px;
          background: #111;
          border: 1px solid #333;
          color: #fff;
          border-radius: 12px;
          margin-bottom: 15px;
        "
      />

      <div
        style="
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
          margin-bottom: 15px;
        "
      >
        <select
          id="edit-muscle"
          style="
            padding: 15px;
            background: #111;
            color: #fff;
            border-radius: 12px;
            border: 1px solid #333;
          "
        >
          <option value="Peito">Peito</option>
          <option value="Costas">Costas</option>
          <option value="Pernas">Pernas</option>
          <option value="Ombros">Ombros</option>
          <option value="Braços">Braços</option>
          <option value="Core">Core</option>
        </select>
        <select
          id="edit-tag"
          style="
            padding: 15px;
            background: #111;
            color: #fff;
            border-radius: 12px;
            border: 1px solid #333;
          "
        >
          <option value="A">Treino A</option>
          <option value="B">Treino B</option>
          <option value="C">Treino C</option>
        </select>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
        <div class="input-box">
          <label>SÉRIES</label><input type="number" id="edit-sets" />
        </div>
        <div class="input-box">
          <label>DESC. (Ex 01:30)</label><input type="text" id="edit-rest" />
        </div>
      </div>

      <button class="btn-action" onclick="saveExerciseData()">SALVAR</button>
      <button
        class="btn-action"
        style="background: #222; color: #fff"
        onclick="closeAllPanels()"
      >
        VOLTAR
      </button>
    </div>

    <div id="history-panel" class="panel">
      <h2 style="color: var(--p)">ANÁLISE</h2>
      <canvas id="mainChart" style="margin-bottom: 25px"></canvas>

      <h3 style="color: var(--p)">SUGESTÕES DE MELHORIA</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 15px">
        <input
          type="text"
          id="feed-input"
          placeholder="O que melhorar?"
          style="
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #333;
            background: #111;
            color: #fff;
          "
        />
        <button
          onclick="addFeedback()"
          style="
            background: var(--p);
            border: none;
            border-radius: 10px;
            padding: 0 15px;
            font-weight: bold;
          "
        >
          +
        </button>
      </div>
      <div id="feedback-list"></div>

      <h3 style="color: var(--p); margin-top: 25px">HISTÓRICO RECENTE</h3>
      <div id="history-container"></div>

      <button
        class="btn-action"
        style="background: #222; color: #fff"
        onclick="exportBackup()"
      >
        EXPORTAR BACKUP
      </button>
      <button
        class="btn-action"
        style="background: #333; color: #fff"
        onclick="closeAllPanels()"
      >
        VOLTAR
      </button>
    </div>

    <nav class="nav">
      <div class="nav-btn active" onclick="closeAllPanels()">TREINO</div>
      <div class="nav-btn" onclick="openAddMode()">+ NOVO</div>
      <div class="nav-btn" onclick="openHistory()">ANÁLISE</div>
      <div
        class="nav-btn"
        onclick="toggleMassMode(true)"
        style="color: var(--danger)"
      >
        LIMPAR
      </div>
    </nav>

    <div
      id="mass-bar"
      style="
        position: fixed;
        bottom: 80px;
        width: 100%;
        background: var(--danger);
        padding: 15px;
        display: none;
        justify-content: space-around;
        z-index: 1001;
      "
    >
      <button
        onclick="deleteSelected()"
        style="
          background: #fff;
          border: none;
          padding: 10px 20px;
          border-radius: 12px;
          font-weight: bold;
        "
      >
        EXCLUIR
      </button>
      <button
        onclick="toggleMassMode(false)"
        style="color: #fff; background: none; border: none"
      >
        FECHAR
      </button>
    </div>

    <script>
      let restInterval,
        sessionInterval,
        sessionSecs = 0;
      let currentFilter = "A",
        isMassMode = false,
        selectedIds = [];
      let db = JSON.parse(localStorage.getItem("gym_v12_db")) || [];
      let history = JSON.parse(localStorage.getItem("gym_v12_history")) || [];
      let feedback = JSON.parse(localStorage.getItem("gym_v12_feedback")) || [];

      function startSessionTimer() {
        sessionInterval = setInterval(() => {
          sessionSecs++;
          let m = Math.floor(sessionSecs / 60),
            s = sessionSecs % 60;
          document.getElementById("session-clock").innerText = `${m
            .toString()
            .padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
        }, 1000);
      }

      function render() {
        const list = document.getElementById("workout-list");
        const filtered = db.filter((ex) => ex.tag === currentFilter);
        list.innerHTML = filtered
          .map((ex) => {
            let lastLogStr = "Sem registros anteriores";
            for (let h of history) {
              let found = h.exercises?.find((e) => e.name === ex.name);
              if (found) {
                lastLogStr = `Anterior: ${found.weight}kg x ${found.reps}`;
                break;
              }
            }

            return `
                <div class="exercise-card" id="card-${
                  ex.id
                }" onclick="handleCardClick(${ex.id})">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="muscle-tag">${ex.muscle}</span>
                        <span style="color:var(--gray); font-size:0.6rem; font-weight:900;">1RM: ${Math.round(
                          ex.weight / (1.0278 - 0.0278 * ex.reps)
                        )}kg</span>
                    </div>
                    <h2 style="margin:8px 0 2px 0;">${ex.name}</h2>
                    <div class="last-log">${lastLogStr}</div>
                    
                    <div class="grid-inputs">
                        <div class="input-box">
                            <label>CARGA (KG)</label>
                            <div class="inc-btn inc-minus" onclick="adj(${
                              ex.id
                            },'weight',-2)">-</div>
                            <input type="number" value="${
                              ex.weight
                            }" onchange="updateVal(${
              ex.id
            },'weight',this.value)">
                            <div class="inc-btn inc-plus" onclick="adj(${
                              ex.id
                            },'weight',2)">+</div>
                        </div>
                        <div class="input-box">
                            <label>REPS</label>
                            <div class="inc-btn inc-minus" onclick="adj(${
                              ex.id
                            },'reps',-1)">-</div>
                            <input type="number" value="${
                              ex.reps
                            }" onchange="updateVal(${ex.id},'reps',this.value)">
                            <div class="inc-btn inc-plus" onclick="adj(${
                              ex.id
                            },'reps',1)">+</div>
                        </div>
                        <div class="input-box"><label>REST</label><span style="font-weight:900; line-height:2">${
                          ex.rest
                        }</span></div>
                    </div>
                    <div class="sets-dots" style="${
                      isMassMode ? "pointer-events:none" : ""
                    }">
                        ${Array.from({ length: ex.sets })
                          .map(
                            (_, i) =>
                              `<div class="dot" onclick="completeSet(this, ${
                                ex.id
                              })">${i + 1}</div>`
                          )
                          .join("")}
                    </div>
                    ${
                      !isMassMode
                        ? `<span style="position:absolute; top:18px; right:18px; color:#333" onclick="openEditMode(event, ${ex.id})">⚙️</span>`
                        : ""
                    }
                </div>`;
          })
          .join("");
        calculateTotals();
      }

      function adj(id, f, v) {
        const ex = db.find((e) => e.id === id);
        ex[f] = Math.max(0, parseFloat(ex[f]) + v);
        saveDB();
        render();
      }
      function completeSet(el, id) {
        el.classList.toggle("active");
        if (el.classList.contains("active"))
          startRestTimer(db.find((e) => e.id === id).rest);
        calculateTotals();
      }
      function startRestTimer(ts) {
        clearInterval(restInterval);
        let [m, s] = ts.split(":").map(Number);
        let total = m * 60 + s;
        restInterval = setInterval(() => {
          total--;
          let dm = Math.floor(total / 60),
            ds = total % 60;
          document.getElementById("clock").innerText = `${dm
            .toString()
            .padStart(2, "0")}:${ds.toString().padStart(2, "0")}`;
          if (total <= 0) {
            clearInterval(restInterval);
            document.getElementById("clock").innerText = "VAI!";
            beep();
          }
        }, 1000);
      }
      function beep() {
        try {
          const a = new AudioContext();
          const o = a.createOscillator();
          o.connect(a.destination);
          o.start();
          o.stop(a.currentTime + 0.2);
        } catch (e) {}
      }
      function resetTimer() {
        clearInterval(restInterval);
        document.getElementById("clock").innerText = "00:00";
      }
      function calculateTotals() {
        let v = 0;
        db.forEach((ex) => {
          const a = document.querySelectorAll(
            `#card-${ex.id} .dot.active`
          ).length;
          v += ex.weight * ex.reps * a;
        });
        document.getElementById("total-vol").innerText = v + "kg";
      }

      function addFeedback() {
        const input = document.getElementById("feed-input");
        if (!input.value) return;
        feedback.unshift({ id: Date.now(), text: input.value });
        input.value = "";
        localStorage.setItem("gym_v12_feedback", JSON.stringify(feedback));
        renderFeedback();
      }
      function renderFeedback() {
        document.getElementById("feedback-list").innerHTML = feedback
          .map(
            (f) =>
              `<div class="feedback-item">${f.text} <span class="del-feed" onclick="delFeed(${f.id})">×</span></div>`
          )
          .join("");
      }
      function delFeed(id) {
        feedback = feedback.filter((f) => f.id !== id);
        localStorage.setItem("gym_v12_feedback", JSON.stringify(feedback));
        renderFeedback();
      }

      function openHistory() {
        togglePanel("history-panel");
        renderFeedback();
        const container = document.getElementById("history-container");
        container.innerHTML = history
          .slice(0, 5)
          .map(
            (h) =>
              `<div style="background:#111; padding:12px; border-radius:15px; margin-bottom:8px; border:1px solid #222;"><b>${h.date}</b> - ${h.volume}kg</div>`
          )
          .join("");
        const ctx = document.getElementById("mainChart").getContext("2d");
        const last = history.slice(0, 10).reverse();
        if (window.mChart) window.mChart.destroy();
        window.mChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: last.map((d) => d.date),
            datasets: [
              {
                data: last.map((d) => d.volume),
                borderColor: "#d1fa1e",
                tension: 0.4,
                fill: true,
                backgroundColor: "rgba(209,250,30,0.1)",
              },
            ],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { display: false }, x: { ticks: { color: "#555" } } },
          },
        });
      }

      // Funções Base
      function openEditMode(e, id) {
        e.stopPropagation();
        const ex = db.find((x) => x.id === id);
        document.getElementById("edit-id").value = ex.id;
        document.getElementById("edit-name").value = ex.name;
        document.getElementById("edit-muscle").value = ex.muscle;
        document.getElementById("edit-tag").value = ex.tag;
        document.getElementById("edit-sets").value = ex.sets;
        document.getElementById("edit-rest").value = ex.rest;
        togglePanel("edit-panel");
      }
      function saveExerciseData() {
        const id = document.getElementById("edit-id").value;
        const data = {
          name: document.getElementById("edit-name").value,
          muscle: document.getElementById("edit-muscle").value,
          tag: document.getElementById("edit-tag").value,
          sets: parseInt(document.getElementById("edit-sets").value),
          rest: document.getElementById("edit-rest").value,
        };
        if (id) {
          const idx = db.findIndex((e) => e.id == id);
          db[idx] = { ...db[idx], ...data };
        } else {
          db.push({ id: Date.now(), ...data, weight: 0, reps: 0 });
        }
        saveDB();
        closeAllPanels();
      }
      function finishSession() {
        const v = parseInt(document.getElementById("total-vol").innerText);
        if (v === 0) return alert("Marque as séries!");
        history.unshift({
          date: new Date().toLocaleDateString("pt-BR"),
          volume: v,
          type: currentFilter,
          exercises: db
            .map((ex) => {
              const a = document.querySelectorAll(
                `#card-${ex.id} .dot.active`
              ).length;
              return a > 0
                ? { name: ex.name, weight: ex.weight, reps: ex.reps }
                : null;
            })
            .filter((x) => x),
        });
        localStorage.setItem("gym_v12_history", JSON.stringify(history));
        location.reload();
      }
      function updateVal(id, f, v) {
        db.find((e) => e.id === id)[f] = parseFloat(v) || 0;
        saveDB();
        calculateTotals();
      }
      function saveDB() {
        localStorage.setItem("gym_v12_db", JSON.stringify(db));
      }
      function togglePanel(id) {
        document
          .querySelectorAll(".panel")
          .forEach((p) => (p.style.display = "none"));
        document.getElementById("main-content").style.display = "none";
        document.getElementById(id).style.display = "block";
      }
      function closeAllPanels() {
        document
          .querySelectorAll(".panel")
          .forEach((p) => (p.style.display = "none"));
        document.getElementById("main-content").style.display = "block";
        render();
      }
      function setFilter(t, b) {
        currentFilter = t;
        document
          .querySelectorAll(".filter-btn")
          .forEach((x) => x.classList.remove("active"));
        b.classList.add("active");
        render();
      }
      function toggleMassMode(on) {
        isMassMode = on;
        document.getElementById("mass-bar").style.display = on
          ? "flex"
          : "none";
        render();
      }
      function handleCardClick(id) {
        if (!isMassMode) return;
        const card = document.getElementById(`card-${id}`);
        if (selectedIds.includes(id)) {
          selectedIds = selectedIds.filter((i) => i !== id);
          card.style.borderColor = "#222";
        } else {
          selectedIds.push(id);
          card.style.borderColor = "var(--danger)";
        }
      }
      function deleteSelected() {
        if (confirm("Apagar?")) {
          db = db.filter((ex) => !selectedIds.includes(ex.id));
          saveDB();
          toggleMassMode(false);
        }
      }
      function openAddMode() {
        document.getElementById("edit-id").value = "";
        document.getElementById("edit-name").value = "";
        document.getElementById("edit-sets").value = 4;
        document.getElementById("edit-rest").value = "01:30";
        togglePanel("edit-panel");
      }
      function exportBackup() {
        prompt("Backup Code:", btoa(JSON.stringify({ db, history, feedback })));
      }

      startSessionTimer();
      render();
    </script>
  </body>
</html>

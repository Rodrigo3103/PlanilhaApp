<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>GymPro Elite Fix</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --p: #d1fa1e;
        --bg: #000;
        --card: #121212;
        --border: #252525;
        --gray: #666;
        --sec: #222;
      }
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        font-family: "Inter", sans-serif;
      }
      body {
        background: var(--bg);
        color: #fff;
        margin: 0;
        padding: 15px 15px 100px 15px;
      }

      .timer-hero {
        background: var(--p);
        color: #000;
        padding: 15px;
        border-radius: 20px;
        text-align: center;
        margin-bottom: 20px;
      }
      #rest-clock {
        font-size: 2.5rem;
        font-weight: 900;
        margin: 0;
      }

      .header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        gap: 8px;
      }
      .stat-card {
        background: var(--card);
        padding: 12px;
        border-radius: 16px;
        flex: 1;
        border: 1px solid var(--border);
        text-align: center;
      }
      .stat-card b {
        color: var(--p);
        font-size: 1.1rem;
        display: block;
      }

      .filter-bar {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 15px;
        scrollbar-width: none;
      }
      .filter-btn {
        flex: 0 0 60px;
        padding: 12px;
        background: var(--card);
        border: 1px solid var(--border);
        color: #fff;
        border-radius: 12px;
        font-weight: 800;
        cursor: pointer;
      }
      .filter-btn.active {
        background: var(--p);
        color: #000;
      }

      .exercise-card {
        background: var(--card);
        border-radius: 20px;
        padding: 18px;
        border: 1px solid var(--border);
        margin-bottom: 15px;
      }
      .badge {
        font-size: 0.65rem;
        background: var(--sec);
        color: var(--p);
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 800;
        text-transform: uppercase;
      }

      .grid-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin: 15px 0;
      }
      .input-box {
        background: #000;
        padding: 8px;
        border-radius: 12px;
        border: 1px solid #222;
        text-align: center;
      }
      .input-box input {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.1rem;
        font-weight: bold;
        width: 100%;
        text-align: center;
        outline: none;
      }

      .sets-dots {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .dot {
        flex: 1;
        min-width: 40px;
        height: 40px;
        background: var(--sec);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
      }
      .dot.active {
        background: var(--p);
        color: #000;
      }

      .panel {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 2000;
        display: none;
        padding: 20px;
        overflow-y: auto;
      }
      .btn-p {
        background: var(--p);
        border: none;
        padding: 18px;
        border-radius: 15px;
        width: 100%;
        font-weight: 900;
        margin-top: 10px;
        cursor: pointer;
        color: #000;
      }

      .nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #080808;
        display: flex;
        padding: 15px 0;
        border-top: 1px solid #222;
      }
      .nav-btn {
        flex: 1;
        text-align: center;
        font-size: 0.7rem;
        color: var(--gray);
        font-weight: bold;
        cursor: pointer;
      }
      .nav-btn.active {
        color: var(--p);
      }
    </style>
  </head>
  <body>
    <div
      id="auth-screen"
      style="
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 5000;
        padding: 30px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      "
    >
      <h1 style="color: var(--p); text-align: center">GymPro Elite</h1>
      <input
        type="text"
        id="user-id"
        placeholder="Digite seu Nome"
        style="
          padding: 18px;
          border-radius: 15px;
          border: 1px solid var(--border);
          background: var(--card);
          color: #fff;
          margin-bottom: 15px;
          outline: none;
        "
      />
      <button class="btn-p" onclick="login()">ENTRAR</button>
    </div>

    <div id="main-app" style="display: none">
      <div class="timer-hero" onclick="resetRest()">
        <h1 id="rest-clock">00:00</h1>
        <small>DESCANSO ATIVO</small>
      </div>

      <div class="header">
        <div class="stat-card">
          <small>VOLUME</small><b id="total-vol">0kg</b>
        </div>
        <div class="stat-card">
          <small>SESSÃO</small><b id="session-time">00:00</b>
        </div>
      </div>

      <div class="filter-bar" id="filter-bar">
        <button class="filter-btn active" onclick="setFilter('A', this)">
          A
        </button>
        <button class="filter-btn" onclick="setFilter('B', this)">B</button>
        <button class="filter-btn" onclick="setFilter('C', this)">C</button>
        <button class="filter-btn" onclick="setFilter('D', this)">D</button>
        <button class="filter-btn" onclick="setFilter('E', this)">E</button>
        <button class="filter-btn" onclick="setFilter('F', this)">F</button>
      </div>

      <div id="exercise-list"></div>
      <button class="btn-p" onclick="finishWorkout()">
        SALVAR TREINO FINALIZADO
      </button>
    </div>

    <div id="history-panel" class="panel">
      <h2 style="color: var(--p)">ANÁLISE</h2>
      <canvas
        id="prog-chart"
        style="max-height: 150px; margin-bottom: 20px"
      ></canvas>
      <canvas
        id="muscle-chart"
        style="max-height: 150px; margin-bottom: 20px"
      ></canvas>
      <div id="history-content"></div>
      <button class="btn-p" onclick="closePanels()">VOLTAR AO TREINO</button>
    </div>

    <div id="add-panel" class="panel">
      <h2 style="color: var(--p)">+ EXERCÍCIO</h2>
      <input
        type="text"
        id="add-name"
        placeholder="Ex: Leg Press"
        class="btn-p"
        style="background: var(--card); color: #fff; text-align: left"
      />
      <select
        id="add-muscle"
        class="btn-p"
        style="background: var(--card); color: #fff"
      >
        <option>Peito</option>
        <option>Costas</option>
        <option>Pernas</option>
        <option>Ombros</option>
        <option>Braços</option>
        <option>Abs</option>
      </select>
      <select
        id="add-tag"
        class="btn-p"
        style="background: var(--card); color: #fff"
      >
        <option value="A">Treino A</option>
        <option value="B">Treino B</option>
        <option value="C">Treino C</option>
        <option value="D">Treino D</option>
        <option value="E">Treino E</option>
        <option value="F">Treino F</option>
      </select>
      <div style="display: flex; gap: 10px">
        <input
          type="number"
          id="add-sets"
          placeholder="Séries"
          class="btn-p"
          style="background: var(--card); color: #fff"
        />
        <input
          type="number"
          id="add-rest"
          placeholder="Descanso"
          class="btn-p"
          style="background: var(--card); color: #fff"
        />
      </div>
      <button class="btn-p" onclick="saveNewExercise()">ADICIONAR</button>
      <button
        class="btn-p"
        style="background: #222; color: #fff"
        onclick="closePanels()"
      >
        FECHAR
      </button>
    </div>

    <nav class="nav">
      <div class="nav-btn active" onclick="closePanels()">TREINO</div>
      <div
        class="nav-btn"
        onclick="document.getElementById('add-panel').style.display='block'"
      >
        + ADD
      </div>
      <div class="nav-btn" onclick="openHistory()">ANÁLISE</div>
      <div class="nav-btn" onclick="logout()">SAIR</div>
    </nav>

    <script>
      const firebaseConfig = { apiKey: "OFFLINE" };
      let userId = "";
      let userData = { exercises: [], history: [] };
      let currentFilter = "A";
      let restInterval,
        sessionSecs = 0;
      let sessionTimer;

      function login() {
        userId = document.getElementById("user-id").value.trim();
        if (!userId) return alert("Digite seu nome!");
        const saved = localStorage.getItem("gp_v4_" + userId);
        if (saved) userData = JSON.parse(saved);
        document.getElementById("auth-screen").style.display = "none";
        document.getElementById("main-app").style.display = "block";
        startSession();
        render();
      }

      function logout() {
        localStorage.removeItem("active_user");
        location.reload();
      }

      function render() {
        const list = document.getElementById("exercise-list");
        const data = (userData.exercises || []).filter(
          (ex) => ex.tag === currentFilter
        );

        list.innerHTML = data
          .map((ex) => {
            const oneRM = Math.round(ex.weight * (1 + ex.reps / 30)) || 0;
            return `
                <div class="exercise-card" id="card-${ex.id}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="badge">${ex.muscle}</span>
                        <small style="color:var(--gray)">1RM Est: ${oneRM}kg</small>
                    </div>
                    <h3 style="margin:10px 0 5px 0">${ex.name}</h3>
                    <div class="grid-inputs">
                        <div class="input-box"><label>CARGA</label><input type="number" value="${
                          ex.weight
                        }" onchange="updateEx('${
              ex.id
            }', 'weight', this.value)"></div>
                        <div class="input-box"><label>REPS</label><input type="number" value="${
                          ex.reps
                        }" onchange="updateEx('${
              ex.id
            }', 'reps', this.value)"></div>
                        <div class="input-box"><label>DESC.</label><div style="font-weight:bold; margin-top:5px;">${
                          ex.rest
                        }s</div></div>
                    </div>
                    <div class="sets-dots">
                        ${Array.from({ length: ex.sets })
                          .map(
                            (_, i) =>
                              `<div class="dot" onclick="toggleSet(this, ${
                                ex.rest
                              })">${i + 1}</div>`
                          )
                          .join("")}
                    </div>
                </div>`;
          })
          .join("");
        calcVol();
      }

      function toggleSet(el, time) {
        el.classList.toggle("active");
        if (el.classList.contains("active")) startRest(time);
        calcVol();
      }

      function startRest(secs) {
        clearInterval(restInterval);
        let t = secs;
        restInterval = setInterval(() => {
          t--;
          document.getElementById("rest-clock").innerText = `${Math.floor(
            t / 60
          )}:${(t % 60).toString().padStart(2, "0")}`;
          if (t <= 0) {
            clearInterval(restInterval);
            document.getElementById("rest-clock").innerText = "VAI!";
          }
        }, 1000);
      }

      function resetRest() {
        clearInterval(restInterval);
        document.getElementById("rest-clock").innerText = "00:00";
      }

      function saveNewExercise() {
        const newEx = {
          id: Date.now().toString(),
          name: document.getElementById("add-name").value,
          muscle: document.getElementById("add-muscle").value,
          tag: document.getElementById("add-tag").value,
          sets: parseInt(document.getElementById("add-sets").value) || 3,
          rest: parseInt(document.getElementById("add-rest").value) || 60,
          weight: 0,
          reps: 0,
        };
        if (!userData.exercises) userData.exercises = [];
        userData.exercises.push(newEx);
        saveData();
        closePanels();
        render();
      }

      function finishWorkout() {
        const vol = parseInt(document.getElementById("total-vol").innerText);
        if (vol === 0) return alert("Marque as séries concluídas!");

        const log = {
          date: new Date().toLocaleDateString("pt-BR"),
          volume: vol,
          tag: currentFilter,
          muscles: {},
        };

        userData.exercises
          .filter((ex) => ex.tag === currentFilter)
          .forEach((ex) => {
            const card = document.getElementById(`card-${ex.id}`);
            const done = card ? card.querySelectorAll(".dot.active").length : 0;
            log.muscles[ex.muscle] =
              (log.muscles[ex.muscle] || 0) + ex.weight * ex.reps * done;
          });

        if (!userData.history) userData.history = [];
        userData.history.unshift(log);
        saveData();

        alert("Treino salvo no histórico!");

        // CORREÇÃO: Limpa os pontos marcados sem sair do app
        document
          .querySelectorAll(".dot")
          .forEach((d) => d.classList.remove("active"));
        sessionSecs = 0;
        calcVol();
      }

      function openHistory() {
        document.getElementById("history-panel").style.display = "block";
        renderCharts();
        const h = userData.history || [];
        document.getElementById("history-content").innerHTML = h
          .map(
            (i) => `
                <div style="background:var(--card); padding:12px; border-radius:12px; margin-top:10px; border-left:4px solid var(--p)">
                    <b>${i.date} - Treino ${i.tag}</b><br><small>Vol: ${i.volume}kg</small>
                </div>
            `
          )
          .join("");
      }

      function renderCharts() {
        const h = (userData.history || []).slice(0, 7).reverse();
        if (h.length === 0) return;

        const ctx1 = document.getElementById("prog-chart").getContext("2d");
        if (window.ch1) window.ch1.destroy();
        window.ch1 = new Chart(ctx1, {
          type: "line",
          data: {
            labels: h.map((x) => x.date.split("/")[0]),
            datasets: [
              { data: h.map((x) => x.volume), borderColor: "#d1fa1e" },
            ],
          },
          options: { plugins: { legend: { display: false } } },
        });
      }

      function calcVol() {
        let v = 0;
        document.querySelectorAll(".exercise-card").forEach((c) => {
          const id = c.id.replace("card-", "");
          const ex = userData.exercises.find((e) => e.id === id);
          if (ex)
            v += ex.weight * ex.reps * c.querySelectorAll(".dot.active").length;
        });
        document.getElementById("total-vol").innerText = v + "kg";
      }

      function startSession() {
        if (sessionTimer) clearInterval(sessionTimer);
        sessionTimer = setInterval(() => {
          sessionSecs++;
          let m = Math.floor(sessionSecs / 60),
            s = sessionSecs % 60;
          document.getElementById("session-time").innerText = `${m}:${s
            .toString()
            .padStart(2, "0")}`;
        }, 1000);
      }

      function updateEx(id, f, v) {
        const ex = userData.exercises.find((e) => e.id === id);
        if (ex) ex[f] = parseFloat(v);
        saveData();
        calcVol();
      }

      function saveData() {
        localStorage.setItem("gp_v4_" + userId, JSON.stringify(userData));
      }
      function setFilter(t, b) {
        currentFilter = t;
        document
          .querySelectorAll(".filter-btn")
          .forEach((x) => x.classList.remove("active"));
        b.classList.add("active");
        render();
      }
      function closePanels() {
        document
          .querySelectorAll(".panel")
          .forEach((p) => (p.style.display = "none"));
      }
    </script>
  </body>
</html>
